<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ตารางหลักสูตร จันทร์–ศุกร์ (พร้อมข้อมูลจริง)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  body{min-height:100vh;background:radial-gradient(1200px 600px at 15% -10%, #064e3b 0%, #052e2b 40%, #041f23 70%, #03181d 100%);color:#e9fbf4;}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.18);border-radius:16px;backdrop-filter:blur(6px);box-shadow:0 10px 28px rgba(0,0,0,.28);}
  .btn{padding:.5rem .8rem;border-radius:10px;font-weight:700}
  .btn-ghost{background:#062a27;color:#d1fae5;border:1px solid rgba(148,163,184,.25)}
  .btn-primary{background:#10b981;color:#042016;box-shadow:0 8px 24px rgba(16,185,129,.35)}
  .btn-danger{background:#ef4444;color:#fff}
  .table-wrap{overflow:auto}table{width:100%;min-width:1150px;border-collapse:separate;border-spacing:0}thead th{position:sticky;top:0;background:#065f46;color:#ecfdf5;font-weight:800;padding:.6rem .75rem;z-index:5;text-align:center}th,td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-bottom:1px solid #e5e7eb;font-size:14px;text-align:center}td:nth-child(2) {text-align: left !important;padding-left: 12px;font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;font-weight: 600;font-size: 15px;color: #065f46 !important;letter-spacing: -0.2px;}th:nth-child(2) {text-align: center !important;}
  tbody tr:nth-child(even){background:#ecfdf5}tbody tr:nth-child(odd){background:#ffffff}tbody td{color:#052e2b;padding:.5rem .75rem}
  .in{width:84px;text-align:center;border:1px solid #cbd5e1;border-radius:8px;padding:.35rem .5rem;background:#fff}
  .badge{padding:4px 10px;border-radius:999px;font-weight:800}
  .badge-red{background:#ef4444;color:#fff}
  .badge-amber{background:#f59e0b;color:#1f2937}
  .badge-green{background:#22c55e;color:#052e15}
  .chart-wrap{height:300px}
  .grid-main{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:1280px){.grid-main{grid-template-columns:420px 1fr}}
  dialog{border:none;border-radius:14px;max-width:1100px;width:96%;background:#062b27;color:#d1fae5}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  textarea{width:100%;min-height:220px;border-radius:10px;background:#04211f;color:#d1fae5;border:1px solid #134e4a;padding:.75rem;font-family:ui-monospace,Menlo,Consolas,monospace}
  .dropzone{border:2px dashed #134e4a;border-radius:12px;padding:14px;text-align:center;background:#072f2a}.dropzone.drag{background:#0b3e37;border-color:#34d399}
  .k{font-weight:800}
  .totals-bar{margin:.5rem 0 0 0;display:flex;gap:12px;flex-wrap:wrap}
  .totals-pill{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:.55rem .9rem;display:flex;align-items:baseline;gap:.5rem}
  .totals-pill .num{font-size:1.9rem;font-weight:900;line-height:1}
  .chip{padding:.15rem .55rem;border-radius:999px;font-weight:800;font-size:.85rem}
  .chip-red{background:#ef4444;color:#fff}
  .chip-amber{background:#f59e0b;color:#1f2937}
  .chip-green{background:#22c55e;color:#052e15}
  :root { --fs-present: 14px; --padY-present: 8px; }
  body.present .grid-main{ grid-template-columns: 1fr !important; }
  body.present aside{ display: none !important; }
  body.present .table-wrap{ overflow: hidden !important; max-height: none !important; }
  body.present th, body.present td{ font-size: var(--fs-present); padding: var(--padY-present) .75rem; line-height:1.15; }
  .hidden-column { display: none !important; }
  .relative.group:hover #hideColumnsMenu { display: block; }
  th:nth-child(11), td:nth-child(11) { text-align: left; }
  .btn-auto-adjust { background: #8b5cf6; color: white; }
  th:nth-child(2) { text-align: center !important;}
  thead th {background: #065f46 !important;font-family: 'Segoe UI', system-ui, sans-serif;font-weight: 700;letter-spacing: 0.5px;font-size: 13px;border: none !important;}
  tbody tr {transition: background-color 0.2s ease;}
  tbody tr:hover {background: #f0fdf4 !important;}
  .badge {font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;font-weight: 700;font-size: 11px;letter-spacing: 0.5px;}
  .btn-primary {background: #10b981;}
  .btn-primary:hover {background: #059669;}
</style>
</head>
<body class="p-4 lg:p-6">
  <header class="mb-4">
    <h1 class="text-xl font-extrabold">ตารางหลักสูตร จันทร์–ศุกร์ (เวอร์ชั่นฝังข้อมูลจริงในไฟล์)</h1>
    <div class="flex gap-2 mt-3">
      <button id="btnImport" class="btn btn-primary">นำเข้า CSV</button>
      <button id="btnExport" class="btn btn-ghost">ส่งออก CSV</button>
      <button id="btnBackupJSON"  class="btn btn-ghost">Backup JSON</button>
      <button id="btnRestoreJSON" class="btn btn-ghost">Restore JSON</button>
      <button id="btnClear" class="btn btn-primary">รีเซ็ตเป็นตัวอย่าง</button>
    </div>
    <input id="jsonFileInput" type="file" accept=".json,application/json" class="hidden" />
  </header>

  <div id="totalsBarContainer" class="totals-bar"></div>

  <section class="grid-main">
    <section class="card p-0 overflow-hidden order-1 xl:order-2">
      <div class="table-wrap max-h-[62vh]">
        <table id="mainTable">
          <thead>
            <tr>
              <th>No.</th><th>วิชา</th><th>รุ่น</th><th>วันเปิดรับสมัคร</th><th>วันที่เริ่มเรียน</th>
              <th>จำนวนที่รับ</th><th>สมัครแล้ว</th><th>คงเหลือ</th><th>สถานะ</th><th>สำรอง</th><th>จัดการ</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-3 py-2 text-xs text-emerald-50/80 bg-emerald-900/20">
        <div id="rowsInfo">แสดง 0 รายการ</div>
        <div id="updatedAt">ข้อมูลล่าสุด: -</div>
      </div>
    </section>
  </section>

  <!-- CSV Import Dialog (เหมือนเดิม) -->
  <dialog id="dlgImport"><form method="dialog" class="p-4 space-y-3">
    <div class="flex items-center justify-between gap-3"><h3 class="text-lg font-bold">นำเข้าข้อมูลจาก CSV</h3>
      <button id="btnCloseImport" value="cancel" class="btn btn-ghost">ปิด</button>
    </div>
    <input id="csvFile" type="file" accept=".csv,text/csv" class="w-full text-sm"/>
    <textarea id="csvArea" placeholder="วางไฟล์ CSV ที่นี่"></textarea>
    <button id="btnParseCSV" type="button" class="btn btn-primary">นำเข้าลงฐานข้อมูล</button>
  </form></dialog>

<script>
const DB_NAME = 'Weekday_DB', STORE = 'courses', DB_VERSION = 1;

// --- <<<< ใส่ข้อมูลจริงตรงนี้ แล้วเปลี่ยน AUTO_SEED ให้ 'true' เสมอ (seed ทุกครั้ง) >>>>
const SAMPLE_CSV = [
"วิชาคอมพิวเตอร์ธุรกิจ (60 ชั่วโมง),1/69,16/09/2568,7 ต.ค. - 29 พ.ย. 2568,20,18,2",
"วิชาภาษาอังกฤษสื่อสาร (60 ชั่วโมง),1/69,16/09/2568,7 ต.ค. - 29 พ.ย. 2568,20,17,3",
"วิชาการเงินส่วนบุคคล (40 ชั่วโมง),1/69,16/09/2568,14 ต.ค. - 22 พ.ย. 2568,25,19,0",
"วิชาการตลาดดิจิทัล (60 ชั่วโมง),1/69,16/09/2568,7 ต.ค. - 29 พ.ย. 2568,20,15,0",
"วิชากราฟิกดีไซน์ (80 ชั่วโมง),1/69,17/09/2568,8 ต.ค. - 27 พ.ย. 2568,15,12,0",
"วิชาตัดเย็บขั้นพื้นฐาน (80 ชั่วโมง),1/69,17/09/2568,8 ต.ค. - 27 พ.ย. 2568,15,9,0",
"วิชาดาต้าอนาไลติกส์เบื้องต้น (60 ชั่วโมง),1/69,18/09/2568,9 ต.ค. - 28 พ.ย. 2568,20,11,0",
"วิชางานครัวและเบเกอรี่ (60 ชั่วโมง),1/69,18/09/2568,9 ต.ค. - 28 พ.ย. 2568,20,20,4",
"วิชาซ่อมคอมพิวเตอร์เบื้องต้น (60 ชั่วโมง),1/69,18/09/2568,9 ต.ค. - 28 พ.ย. 2568,20,16,0"
].join("\n");
const AUTO_SEED = true; // <<<< สำคัญ! ต้อง true เสมอเพื่อ seed ทุกครั้ง >>>>

// auto seed “จริง” ทุกครั้งที่เข้า (clear db เสมอ)
(async function realSeedInit() {
  if (!window.indexedDB) return alert('เบราว์เซอร์นี้ไม่รองรับ IndexedDB');
  await clearDB();
  await importCSV(SAMPLE_CSV);
  await render();
  showTotals();
})();

function parseCSVrows(text){
  return (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean).map(l=>l.split(","));
}

function uid(){return Date.now().toString(36) + Math.random().toString(36).slice(2,7);}
function escapeHtml(s){return String(s).replace(/[&<>"]/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;" }[m]));}

function openDB(){return new Promise((res,rej)=>{
  const req=indexedDB.open(DB_NAME,DB_VERSION);
  req.onerror=()=>rej(req.error); req.onsuccess=()=>res(req.result);
  req.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(STORE))db.createObjectStore(STORE,{keyPath:"id"});}
});}
function clearDB(){return openDB().then(db=>new Promise(r=>{
  const tx=db.transaction([STORE],"readwrite");const st=tx.objectStore(STORE);st.clear();
  tx.oncomplete=()=>{db.close();r();};tx.onerror=()=>{db.close();r();};
}));}

async function importCSV(text){
  await clearDB();
  const rows=parseCSVrows(text);
  const db=await openDB();
  const tx=db.transaction([STORE],"readwrite");
  rows.forEach(raw=>{
    if(raw.length>=7)tx.objectStore(STORE).put({
      id:uid(),subject:raw[0],batch:raw[1],openDate:raw[2],learnDate:raw[3],
      cap:+raw[4],reg:+raw[5],reserve:+raw[6],left:Math.max(0,+raw[4]-(+raw[5]))
    });
  });
  return new Promise((r)=>{tx.oncomplete=()=>{db.close();r();};});
}
async function getAll(){const db=await openDB();return new Promise(res=>{
  const rows=[];const req=db.transaction([STORE]).objectStore(STORE).openCursor();
  req.onsuccess=e=>{const c=e.target.result;if(c){rows.push(c.value);c.continue();}else{db.close();res(rows);}}
});}

async function render(){
  const tb=document.getElementById('tbody');tb.innerHTML="";
  const rows=await getAll();
  rows.forEach((r,i)=>{
    tb.innerHTML+=`<tr>
    <td>${i+1}</td><td>${escapeHtml(r.subject)}</td><td>${escapeHtml(r.batch)}</td>
    <td>${escapeHtml(r.openDate)}</td><td>${escapeHtml(r.learnDate)}</td>
    <td>${r.cap}</td><td>${r.reg}</td><td>${r.left}</td>
    <td>${statusBadge(r)}</td><td>${r.reserve}</td>
    <td><button onclick="delRow('${r.id}')">ลบ</button></td>
    </tr>`;
  });
  document.getElementById('rowsInfo').textContent=`แสดง ${rows.length} รายการ`;
  document.getElementById('updatedAt').textContent='ข้อมูลล่าสุด: '+new Date().toLocaleString('th-TH');
}
function statusBadge(r){
  const pct=r.cap>0?Math.round((r.reg/r.cap)*100):0;
  if(pct>=100)return'<span class="badge badge-red">เต็มแล้ว</span>';
  if(pct>=80)return`<span class="badge badge-amber">${pct}% ใกล้เต็ม</span>`;
  return`<span class="badge badge-green">${pct}% รับได้</span>`;
}
async function delRow(id){const db=await openDB();
  db.transaction([STORE],"readwrite").objectStore(STORE).delete(id);
  db.close();await render();showTotals();}

async function showTotals(){
  const rows=await getAll();let total=0;rows.forEach(r=>{total+=(+r.reg||0);});
  document.getElementById('totalsBarContainer').textContent="ผู้สมัครรวม "+total+" คน";
}

// ====== Events for import/export/backup/restore/csv =====
document.getElementById('btnClear').onclick=async()=>{
  await clearDB();await importCSV(SAMPLE_CSV);await render();showTotals();alert('โหลดข้อมูลตัวอย่างใหม่สำเร็จ');
}
document.getElementById('btnImport').onclick=()=>{document.getElementById('dlgImport').showModal();}
document.getElementById('btnCloseImport').onclick=()=>document.getElementById('dlgImport').close();
document.getElementById('btnParseCSV').onclick=async()=>{
  let text=document.getElementById('csvArea').value.trim();
  if(!text && document.getElementById('csvFile').files[0]) text=await document.getElementById('csvFile').files[0].text();
  if(!text)return alert('กรุณาเลือกหรือวางไฟล์ CSV');await importCSV(text);await render();showTotals();document.getElementById('dlgImport').close();
}
document.getElementById('btnExport').onclick=async()=>{
  const rows=await getAll();
  const lines=rows.map(r=>
    [r.subject,r.batch,r.openDate,r.learnDate,r.cap,r.reg,r.reserve].join(",")
  );
  const blob=new Blob([lines.join("\n")],{type:"text/csv"});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="export.csv";a.click();setTimeout(()=>URL.revokeObjectURL(a.href),2000);
};
document.getElementById('btnBackupJSON').onclick=async()=>{
  const rows=await getAll();
  const blob=new Blob([JSON.stringify(rows)],{type:"application/json"});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="backup.json";a.click();setTimeout(()=>URL.revokeObjectURL(a.href),2000);
};
document.getElementById('btnRestoreJSON').onclick=()=>document.getElementById('jsonFileInput').click();
document.getElementById('jsonFileInput').onchange=async(e)=>{
  const file=e.target.files[0];if(!file)return;const js=JSON.parse(await file.text());
  await clearDB();const db=await openDB();const tx=db.transaction([STORE],"readwrite");
  js.forEach(r=>{if(r.subject)tx.objectStore(STORE).put(Object.assign({id:uid()},r));});
  tx.oncomplete=()=>{db.close();render();showTotals();};
};
</script>
</body>
</html>