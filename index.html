<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡∏®‡∏∏‡∏Å‡∏£‡πå (Weekday_DB + CSV Import)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  /* ===== THEME: Weekday (Emerald/Teal) ===== */
  body{
    min-height:100vh;
    background:
      radial-gradient(1200px 600px at 15% -10%, #064e3b 0%, #052e2b 40%, #041f23 70%, #03181d 100%);
    color:#e9fbf4;
  }
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
    border:1px solid rgba(148,163,184,.18);
    border-radius:16px;
    backdrop-filter:blur(6px);
    box-shadow:0 10px 28px rgba(0,0,0,.28);
  }
  .btn{padding:.5rem .8rem;border-radius:10px;font-weight:700}
  .btn-ghost{background:#062a27;color:#d1fae5;border:1px solid rgba(148,163,184,.25)}
  .btn-primary{background:#10b981;color:#042016;box-shadow:0 8px 24px rgba(16,185,129,.35)}
  .btn-danger{background:#ef4444;color:#fff}
  .table-wrap{overflow:auto}
  table{width:100%;min-width:1150px;border-collapse:separate;border-spacing:0}
  thead th{position:sticky;top:0;background:#065f46;color:#ecfdf5;font-weight:800;padding:.6rem .75rem;z-index:5;text-align:center}
  th,td{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border-bottom:1px solid #e5e7eb;font-size:14px;text-align:center}
  /* ‡∏à‡∏±‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ß‡∏¥‡∏ä‡∏≤" ‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á */
  td:nth-child(2) {
    text-align: left !important;
    padding-left: 12px;
    font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
    font-weight: 600;
    font-size: 15px;
    color: #065f46 !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ */
    letter-spacing: -0.2px;
  }
  /* ‡∏¢‡πâ‡∏≥‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ß‡∏¥‡∏ä‡∏≤" ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏™‡∏°‡∏≠ */
  th:nth-child(2) {text-align: center !important;}
  
  tbody tr:nth-child(even){background:#ecfdf5} 
  tbody tr:nth-child(odd){background:#ffffff}
  tbody td{color:#052e2b;padding:.5rem .75rem}
  .in{width:84px;text-align:center;border:1px solid #cbd5e1;border-radius:8px;padding:.35rem .5rem;background:#fff}
  .badge{padding:4px 10px;border-radius:999px;font-weight:800}
  .badge-red{background:#ef4444;color:#fff}
  .badge-amber{background:#f59e0b;color:#1f2937}
  .badge-green{background:#22c55e;color:#052e15}
  .chart-wrap{height:300px}
  .grid-main{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:1280px){.grid-main{grid-template-columns:420px 1fr}}
  dialog{border:none;border-radius:14px;max-width:1100px;width:96%;background:#062b27;color:#d1fae5}
  dialog::backdrop{background:rgba(0,0,0,.55)}
  textarea{width:100%;min-height:220px;border-radius:10px;background:#04211f;color:#d1fae5;border:1px solid #134e4a;padding:.75rem;font-family:ui-monospace,Menlo,Consolas,monospace}
  .dropzone{border:2px dashed #134e4a;border-radius:12px;padding:14px;text-align:center;background:#072f2a}
  .dropzone.drag{background:#0b3e37;border-color:#34d399}
  .k{font-weight:800}
  
  /* totals */
  .totals-bar{margin:.5rem 0 0 0;display:flex;gap:12px;flex-wrap:wrap}
  .totals-pill{background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
    border:1px solid rgba(148,163,184,.25);border-radius:999px;padding:.55rem .9rem;display:flex;align-items:baseline;gap:.5rem}
  .totals-pill .num{font-size:1.9rem;font-weight:900;line-height:1}
  .chip{padding:.15rem .55rem;border-radius:999px;font-weight:800;font-size:.85rem}
  .chip-red{background:#ef4444;color:#fff}
  .chip-amber{background:#f59e0b;color:#1f2937}
  .chip-green{background:#22c55e;color:#052e15}
  
  /* ‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏£‡∏≠‡∏• (Present/Kiosk) */
  :root { --fs-present: 14px; --padY-present: 8px; }
  body.present .grid-main{ grid-template-columns: 1fr !important; }
  body.present aside{ display: none !important; }
  body.present .table-wrap{ overflow: hidden !important; max-height: none !important; }
  body.present th, body.present td{ font-size: var(--fs-present); padding: var(--padY-present) .75rem; line-height:1.15; }
  
  /* Hide Columns Feature */
  .hidden-column { display: none !important; }
  .relative.group:hover #hideColumnsMenu { display: block; }
  
  /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ */
  th:nth-child(11), td:nth-child(11) { text-align: left; }

  /* Auto Adjust Button */
  .btn-auto-adjust { background: #8b5cf6; color: white; }
  
  /* ==== ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏ß‡∏¥‡∏ä‡∏≤" ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏¥‡∏î‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏ï‡πà‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á ==== */
  th:nth-child(2) {
    text-align: center !important;
  }

  /* ===== ‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå ===== */
  thead th {
    background: #065f46 !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ */
    font-family: 'Segoe UI', system-ui, sans-serif;
    font-weight: 700;
    letter-spacing: 0.5px;
    font-size: 13px;
    border: none !important;
  }

  tbody tr {
    transition: background-color 0.2s ease; /* ‡πÅ‡∏Ñ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á */
  }

  tbody tr:hover {
    background: #f0fdf4 !important; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
  }

  .badge {
    font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.5px;
  }

  .btn-primary {
    background: #10b981; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ */
  }

  .btn-primary:hover {
    background: #059669; /* ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover */
  }
</style>

<!-- Plugin: sync doughnut colors with status chips (‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß=‡πÅ‡∏î‡∏á, ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°=‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á, ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ=‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß) -->
<script>
(function(){
  function registerPlugin(){
    if (!window.Chart || !Chart.register) return false;
    const StatusColorPlugin = {
      id: 'statusColorSync',
      beforeUpdate(chart){
        try{
          if (!chart || chart.config?.type !== 'doughnut') return;
          const map = {"‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß":"#ef4444","‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°":"#f59e0b","‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ":"#22c55e"};
          const labels = chart.config?.data?.labels || [];
          const colors = labels.map(l => map[l] || '#94a3b8');
          (chart.data.datasets||[]).forEach(ds => {
            ds.backgroundColor = colors;
            ds.hoverBackgroundColor = colors;
            if (typeof ds.borderWidth === 'undefined') ds.borderWidth = 0;
          });
        }catch(e){}
      }
    };
    try{ Chart.register(StatusColorPlugin); }catch(e){}
    return true;
  }
  if (!registerPlugin()){
    let tries=0; const t=setInterval(()=>{ tries++; if (registerPlugin()||tries>40) clearInterval(t); },50);
  }
})();
</script>

</head>
<body class="p-4 lg:p-6">
  <header class="mb-4">
    <div class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <!-- Emerald logo -->
        <svg width="40" height="40" viewBox="0 0 64 64" aria-hidden="true">
          <defs><linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#34d399"/><stop offset="1" stop-color="#06b6d4"/>
          </linearGradient></defs>
          <circle cx="32" cy="32" r="30" fill="url(#g1)" opacity=".2"/>
          <path d="M18 36c10-18 18-18 28 0-10 18-18 18-28 0z" fill="url(#g1)"/>
        </svg>
        <div>
          <h1 class="text-xl font-extrabold leading-tight">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£ ‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡∏®‡∏∏‡∏Å‡∏£‡πå</h1>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" id="btnFullscreen" class="btn btn-ghost">‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡∏ô‡∏ï‡πå</button>
        <button type="button" id="btnNoScroll"   class="btn btn-ghost">‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏Å‡∏£‡∏≠‡∏•</button>
        <button type="button" id="btnImport"     class="btn btn-primary">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV</button>
        <button type="button" id="btnAdd"        class="btn btn-ghost">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡πÉ‡∏´‡∏°‡πà</button>
        <button type="button" id="btnExport"     class="btn btn-ghost">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
        <button type="button" id="btnClear"      class="btn btn-ghost">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
        
        <!-- ‡∏õ‡∏∏‡πà‡∏° Auto Adjust -->
        <button type="button" id="btnAutoAdjust" class="btn btn-auto-adjust">Auto Adjust</button>
        
        <!-- Hide Columns Dropdown -->
        <div class="relative group">
          <button type="button" id="btnHideColumns" class="btn btn-ghost">‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
          <div id="hideColumnsMenu" class="hidden absolute right-0 mt-1 w-64 bg-[#062a27] border border-[#134e4a] rounded-lg shadow-lg z-50 p-3">
            <div class="text-sm font-bold mb-2 text-[#d1fae5]">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô:</div>
            <div class="space-y-2 max-h-60 overflow-y-auto">
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="0" checked> No.
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="1" checked> ‡∏ß‡∏¥‡∏ä‡∏≤
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="2" checked> ‡∏£‡∏∏‡πà‡∏ô
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="3" checked> ‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="4" checked> ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="5" checked> ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="6" checked> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="7" checked> ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="8" checked> ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="9" checked> ‡∏™‡∏≥‡∏£‡∏≠‡∏á
              </label>
              <label class="flex items-center gap-2 text-sm text-[#d1fae5]">
                <input type="checkbox" class="column-toggle" data-column="10" checked> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£
              </label>
            </div>
            <div class="flex justify-between mt-3 pt-2 border-t border-[#134e4a]">
              <button type="button" id="btnHideAllColumns" class="btn btn-ghost text-xs">‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              <button type="button" id="btnShowAllColumns" class="btn btn-ghost text-xs">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
          </div>
        </div>

        <button type="button" id="btnBackupJSON"  class="btn btn-ghost">Backup JSON</button>
        <button type="button" id="btnRestoreJSON" class="btn btn-ghost">Restore JSON</button>
        <input id="jsonFileInput" type="file" accept=".json,application/json" class="hidden" />
        <button id="btnHardReset"  class="btn btn-danger">‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô (Hard Reset)</button>
      </div>
    </div>
  </header>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏ß‡∏° -->
  <div id="totalsBarContainer" class="totals-bar">
    <div class="totals-pill"><span>‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
      <strong class="num" id="totalApplicantsNum">0</strong><span>‡∏Ñ‡∏ô</span><select id="batchFilter" class="ml-3 px-2 py-1 rounded text-black text-sm"><option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏∏‡πà‡∏ô</option></select></div>
    <div class="totals-pill"><span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ß‡∏°:</span>
      <span class="chip chip-red"   id="chipFull">‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß 0</span>
      <span class="chip chip-amber" id="chipNear">‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏° 0</span>
      <span class="chip chip-green" id="chipOk">‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ 0</span>
    </div>
  </div>

  <section class="grid-main">
    <aside class="space-y-3 order-2 xl:order-1">
      <div class="card p-4">
        <h3 class="font-bold mb-2">‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ô‡∏±‡πà‡∏á</h3>
        <div class="chart-wrap"><canvas id="chartStatus"></canvas></div>
        <p class="text-xs opacity-80 mt-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: <span class="badge badge-red">‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</span> / <span class="badge badge-amber">‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏° (‚â•80%)</span> / <span class="badge badge-green">‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ</span></p>
      </div>
      <div class="card p-4">
        <h3 class="font-bold mb-2">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≤‡∏°‡∏ß‡∏¥‡∏ä‡∏≤</h3>
        <div class="chart-wrap"><canvas id="chartCourse"></canvas></div>
      </div>
    </aside>

    <section class="card p-0 overflow-hidden order-1 xl:order-2">
      <div class="table-wrap max-h-[62vh]">
        <table id="mainTable">
          <thead>
            <tr>
              <th>No.</th><th>‡∏ß‡∏¥‡∏ä‡∏≤</th><th>‡∏£‡∏∏‡πà‡∏ô</th><th>‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th><th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö</th><th>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏™‡∏≥‡∏£‡∏≠‡∏á</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-3 py-2 text-xs text-emerald-50/80 bg-emerald-900/20">
        <div id="rowsInfo">‡πÅ‡∏™‡∏î‡∏á 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div id="updatedAt">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: -</div>
      </div>
    </section>
  </section>

  <!-- Import CSV Dialog -->
  <dialog id="dlgImport">
    <form method="dialog" class="p-4 space-y-3">
      <div class="flex items-center justify-between gap-3">
        <h3 class="text-lg font-bold">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å CSV</h3>
        <div class="flex items-center gap-2">
          <button id="btnDownloadTemplate" type="button" class="btn btn-ghost">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏°‡πà‡πÅ‡∏ö‡∏ö .csv</button>
          <button id="btnCloseImport" value="cancel" class="btn btn-ghost">‡∏õ‡∏¥‡∏î</button>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <label class="k">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</label>
          <input id="csvFile" type="file" accept=".csv,text/csv" class="w-full text-sm"/>
          <div id="dropArea" class="dropzone text-sm">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå .csv ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</div>
          <div class="text-xs opacity-80">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô , ; ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡πá‡∏ö / ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ "‚Ä¶" ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏°‡∏°‡∏≤‡πÉ‡∏ô‡∏Ñ‡πà‡∏≤</div>
        </div>
        <div class="space-y-2">
          <label class="k">‡∏´‡∏£‡∏∑‡∏≠ ‡∏ß‡∏≤‡∏á CSV</label>
          <textarea id="csvArea" placeholder='subject,batch,openDate,learnDate,cap,reg,reserve&#10;"‡∏ß‡∏¥‡∏ä‡∏≤‚Ä¶",1/69,16/09/2568,7 ‡∏ï.‡∏Ñ. - 29 ‡∏û.‡∏¢. 2568,20,11,0'></textarea>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
        <label class="flex items-center gap-2 text-sm">
          <input id="hasHeader" type="checkbox" class="scale-110" checked>
          ‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (Header)
        </label>
        <div class="text-sm">
          ‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:
          <label class="ml-2"><input type="radio" name="mode" id="modeReplace" checked> ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
          <label class="ml-4"><input type="radio" name="mode" id="modeMerge"> ‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏° ‡∏ß‡∏¥‡∏ä‡∏≤+‡∏£‡∏∏‡πà‡∏ô)</label>
        </div>
        <div class="flex justify-end">
          <button id="btnParseCSV" type="button" class="btn btn-primary">‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß/‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏°‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</button>
        </div>
      </div>

      <div id="mapFields" class="hidden card p-3"></div>
      <div id="csvPreview" class="hidden card p-3 overflow-auto max-h-[40vh] bg-[#072f2a]"></div>

      <div class="flex items-center justify-between">
        <div class="text-xs opacity-75">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: <code>subject,batch,openDate,learnDate,cap,reg,reserve</code> (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ <code>left</code> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏´‡πâ)</div>
        <div class="flex items-center gap-2">
          <button id="btnCommitCSV" type="button" class="btn btn-primary" disabled>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
      </div>
    </form>
  </dialog>

<script>
/* ===================== CONFIG (Weekday) - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ===================== */
const DB_NAME = 'Weekday_DB';
const DB_VERSION = 1;
const STORE = 'courses';
const AUTO_SEED = true; // ‚Üê ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô true
const OLD_DB_NAMES = ['weekday_db', 'Weekend_DB', 'weekend_db'];

/* ===== CSV ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‚Äì‡∏®‡∏∏‡∏Å‡∏£‡πå) ===== */
const SAMPLE_CSV = [
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à (60 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,16/09/2568,7 ‡∏ï.‡∏Ñ. - 29 ‡∏û.‡∏¢. 2568,20,18,2",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ (60 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,16/09/2568,7 ‡∏ï.‡∏Ñ. - 29 ‡∏û.‡∏¢. 2568,20,17,3",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏• (40 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,16/09/2568,14 ‡∏ï.‡∏Ñ. - 22 ‡∏û.‡∏¢. 2568,25,19,0",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏• (60 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,16/09/2568,7 ‡∏ï.‡∏Ñ. - 29 ‡∏û.‡∏¢. 2568,20,15,0",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå (80 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,17/09/2568,8 ‡∏ï.‡∏Ñ. - 27 ‡∏û.‡∏¢. 2568,15,12,0",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏ï‡∏±‡∏î‡πÄ‡∏¢‡πá‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô (80 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,17/09/2568,8 ‡∏ï.‡∏Ñ. - 27 ‡∏û.‡∏¢. 2568,15,9,0",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏î‡∏≤‡∏ï‡πâ‡∏≤‡∏≠‡∏ô‡∏≤‡πÑ‡∏•‡∏ï‡∏¥‡∏Å‡∏™‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (60 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,18/09/2568,9 ‡∏ï.‡∏Ñ. - 28 ‡∏û.‡∏¢. 2568,20,11,0",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà (60 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,18/09/2568,9 ‡∏ï.‡∏Ñ. - 28 ‡∏û.‡∏¢. 2568,20,20,4",
"‡∏ß‡∏¥‡∏ä‡∏≤‡∏ã‡πà‡∏≠‡∏°‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô (60 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á),1/69,18/09/2568,9 ‡∏ï.‡∏Ñ. - 28 ‡∏û.‡∏¢. 2568,20,16,0"
].join("\n");

/* ===================== Helpers ===================== */
const byId = id => document.getElementById(id);
const qs   = sel => document.querySelector(sel);

/* ===================== IndexedDB helpers (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£) ===================== */
const __idbConns = new Set();

function openDB() {
    return new Promise((resolve, reject) => {
        console.log('üìÇ Opening database:', DB_NAME);
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        
        req.onerror = () => {
            console.error('‚ùå Database opening error:', req.error);
            reject(req.error);
        };
        
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            console.log('üîÑ Upgrading DB...');
            if (!db.objectStoreNames.contains(STORE)) {
                db.createObjectStore(STORE, { keyPath: 'id' });
                console.log('‚úÖ Object store created');
            }
        };
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            __idbConns.add(db);
            console.log('‚úÖ Database opened successfully');
            
            db.onversionchange = () => {
                console.log('üîÑ Database version changed, closing...');
                db.close();
                __idbConns.delete(db);
            };
            
            resolve(db);
        };
    });
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô idbGetAll ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Ç‡∏∂‡πâ‡∏ô
async function idbGetAll() {
    let db;
    try {
        db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction([STORE], 'readonly');
            const store = tx.objectStore(STORE);
            const request = store.getAll();
            
            request.onsuccess = () => {
                console.log('üì• Data retrieved:', request.result.length, 'items');
                resolve(request.result || []);
            };
            
            request.onerror = () => {
                console.error('‚ùå Error getting data:', request.error);
                reject(request.error);
            };
            
            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ transaction ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î connection
            tx.oncomplete = () => {
                console.log('‚úÖ Transaction completed');
                try { 
                    db.close(); 
                    __idbConns.delete(db);
                } catch(e) {
                    console.warn('Warning closing db:', e);
                }
            };
            
            tx.onerror = () => {
                console.error('‚ùå Transaction error:', tx.error);
                reject(tx.error);
            };
        });
    } catch (error) {
        console.error('‚ùå Error in idbGetAll:', error);
        if (db) {
            try { 
                db.close(); 
                __idbConns.delete(db);
            } catch(e) {}
        }
        return [];
    }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô idbPut ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Ç‡∏∂‡πâ‡∏ô
async function idbPut(item) {
    let db;
    try {
        db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction([STORE], 'readwrite');
            const store = tx.objectStore(STORE);
            
            if (!item.id) {
                item.id = uid();
            }
            
            const request = store.put(item);
            
            request.onsuccess = () => {
                console.log('üíæ Data saved:', item.subject);
                resolve(true);
            };
            
            request.onerror = () => {
                console.error('‚ùå Error saving data:', request.error);
                reject(request.error);
            };
            
            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ transaction ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î connection
            tx.oncomplete = () => {
                console.log('‚úÖ Save transaction completed');
                try { 
                    db.close(); 
                    __idbConns.delete(db);
                } catch(e) {
                    console.warn('Warning closing db:', e);
                }
            };
            
            tx.onerror = () => {
                console.error('‚ùå Save transaction error:', tx.error);
                reject(tx.error);
            };
        });
    } catch (error) {
        console.error('‚ùå Error in idbPut:', error);
        if (db) {
            try { 
                db.close(); 
                __idbConns.delete(db);
            } catch(e) {}
        }
        throw error;
    }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô idbBulkPut
async function idbBulkPut(items) {
    let db;
    try {
        db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction([STORE], 'readwrite');
            const store = tx.objectStore(STORE);
            
            items.forEach(item => {
                if (!item.id) {
                    item.id = uid();
                }
                store.put(item);
            });
            
            tx.oncomplete = () => {
                console.log('üíæ Bulk save completed:', items.length, 'items');
                resolve(true);
            };
            
            tx.onerror = () => {
                console.error('‚ùå Bulk save error:', tx.error);
                reject(tx.error);
            };
            
            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ transaction ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î connection
            tx.oncomplete = () => {
                console.log('‚úÖ Bulk transaction completed');
                try { 
                    db.close(); 
                    __idbConns.delete(db);
                } catch(e) {
                    console.warn('Warning closing db:', e);
                }
            };
        });
    } catch (error) {
        console.error('‚ùå Error in idbBulkPut:', error);
        if (db) {
            try { 
                db.close(); 
                __idbConns.delete(db);
            } catch(e) {}
        }
        throw error;
    }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô idbDelete
async function idbDelete(id) {
    let db;
    try {
        db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction([STORE], 'readwrite');
            const store = tx.objectStore(STORE);
            const request = store.delete(id);
            
            request.onsuccess = () => {
                console.log('üóëÔ∏è Data deleted:', id);
                resolve(true);
            };
            
            request.onerror = () => {
                console.error('‚ùå Error deleting data:', request.error);
                reject(request.error);
            };
            
            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ transaction ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î connection
            tx.oncomplete = () => {
                console.log('‚úÖ Delete transaction completed');
                try { 
                    db.close(); 
                    __idbConns.delete(db);
                } catch(e) {
                    console.warn('Warning closing db:', e);
                }
            };
        });
    } catch (error) {
        console.error('‚ùå Error in idbDelete:', error);
        if (db) {
            try { 
                db.close(); 
                __idbConns.delete(db);
            } catch(e) {}
        }
        throw error;
    }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô idbClear
async function idbClear() {
    let db;
    try {
        db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction([STORE], 'readwrite');
            const store = tx.objectStore(STORE);
            const request = store.clear();
            
            request.onsuccess = () => {
                console.log('üßπ Database cleared');
                resolve(true);
            };
            
            request.onerror = () => {
                console.error('‚ùå Error clearing database:', request.error);
                reject(request.error);
            };
            
            // ‚úÖ ‡∏£‡∏≠‡πÉ‡∏´‡πâ transaction ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏õ‡∏¥‡∏î connection
            tx.oncomplete = () => {
                console.log('‚úÖ Clear transaction completed');
                try { 
                    db.close(); 
                    __idbConns.delete(db);
                } catch(e) {
                    console.warn('Warning closing db:', e);
                }
            };
        });
    } catch (error) {
        console.error('‚ùå Error in idbClear:', error);
        if (db) {
            try { 
                db.close(); 
                __idbConns.delete(db);
            } catch(e) {}
        }
        throw error;
    }
}

/* ===================== Hard Reset ===================== */
function deleteDBOnce(name) {
    return new Promise(resolve => {
        console.log('üóëÔ∏è Deleting database:', name);
        const req = indexedDB.deleteDatabase(name);
        let s = 'pending';
        req.onblocked = () => { 
            s = 'blocked'; 
            console.warn('‚ö†Ô∏è Database blocked:', name);
            resolve({name, status: s}); 
        };
        req.onerror = () => { 
            s = 'error'; 
            console.error('‚ùå Database deletion error:', name, req.error);
            resolve({name, status: s, error: req.error}); 
        };
        req.onsuccess = () => { 
            s = 'deleted'; 
            console.log('‚úÖ Database deleted:', name);
            resolve({name, status: s}); 
        };
    });
}

async function clearStoreFallback() {
    try {
        await idbClear();
        return {status: 'cleared-store'};
    } catch(e) {
        console.error('‚ùå Clear store fallback error:', e);
        return {status: 'failed', error: e};
    }
}

function setSkipSeedOnce() {
    try {
        sessionStorage.setItem('SKIP_SEED_ONCE', '1');
        console.log('‚è≠Ô∏è Skip seed flag set');
    } catch(e) {
        console.warn('‚ö†Ô∏è Cannot set skip seed flag:', e);
    }
}

function consumeSkipSeedOnce() {
    try {
        sessionStorage.removeItem('SKIP_SEED_ONCE');
        console.log('‚è≠Ô∏è Skip seed flag consumed');
    } catch(e) {
        console.warn('‚ö†Ô∏è Cannot remove skip seed flag:', e);
    }
}

function shouldSeed() {
    try {
        const should = AUTO_SEED && !sessionStorage.getItem('SKIP_SEED_ONCE');
        console.log('üå± Should seed:', should);
        return should;
    } catch(e) {
        console.warn('‚ö†Ô∏è Error checking seed condition:', e);
        return AUTO_SEED;
    }
}

async function hardReset({silent = false, reload = true} = {}) {
    console.log('üîÑ Starting hard reset...');
    await idbCloseAll();
    
    try {
        const bc = new BroadcastChannel('Weekday_DB_reset');
        bc.postMessage('RESET');
        bc.close();
        console.log('üì¢ Broadcast reset message');
    } catch(e) {
        console.warn('‚ö†Ô∏è Broadcast channel error:', e);
    }
    
    try {
        localStorage.removeItem('ai_weekday_table_v1');
        Object.keys(localStorage).forEach(k => {
            if (/(weekday|weekend|ai_week(day|end))/i.test(k)) {
                localStorage.removeItem(k);
                console.log('üóëÔ∏è Removed localStorage key:', k);
            }
        });
    } catch(e) {
        console.warn('‚ö†Ô∏è LocalStorage cleanup error:', e);
    }
    
    let results = [];
    results.push(await deleteDBOnce(DB_NAME));
    for (const n of OLD_DB_NAMES) {
        results.push(await deleteDBOnce(n));
    }
    
    if (results.some(r => r.status === 'blocked' || r.status === 'error')) {
        const fb = await clearStoreFallback();
        if (!silent) {
            alert(`‡∏•‡∏ö‡∏ê‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ö‡∏•‡πá‡∏≠‡∏Å/‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‚Üí ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå store ‡πÅ‡∏ó‡∏ô (${fb.status})`);
        }
    } else if (!silent) {
        alert(results.map(r => `${r.name}: ${r.status}`).join('\n'));
    }
    
    if (reload) {
        console.log('üîÑ Reloading page...');
        location.reload();
    }
}

// Close all connections
async function idbCloseAll() {
    console.log('üîí Closing all database connections...');
    for (const db of Array.from(__idbConns)) {
        try {
            db.close();
            console.log('‚úÖ Closed database connection');
        } catch(e) {
            console.warn('‚ö†Ô∏è Error closing database:', e);
        }
        __idbConns.delete(db);
    }
    await new Promise(r => setTimeout(r, 100));
}

// Broadcast channel listener
try {
    const bcListen = new BroadcastChannel('Weekday_DB_reset');
    bcListen.onmessage = async (ev) => {
        if (ev?.data === 'RESET') {
            console.log('üì¢ Received reset broadcast');
            await idbCloseAll();
            location.reload();
        }
    };
} catch(e) {
    console.warn('‚ö†Ô∏è Broadcast channel listener error:', e);
}

/* ===================== Utilities ===================== */
function uid() {
    return Date.now().toString(36) + Math.random().toString(36).slice(2, 8);
}

function escapeHtml(s) {
    return String(s).replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", "&#39;");
}

function nowThai() {
    const d = new Date();
    const y = d.getFullYear() + 543;
    const p = n => String(n).padStart(2, '0');
    return `${p(d.getDate())}/${p(d.getMonth() + 1)}/${y} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
}

function clampNum(v, min) {
    const n = parseInt((v ?? '').toString().replace(/[, ]/g, ''), 10);
    return isNaN(n) ? min : Math.max(min, n);
}

/* ===================== App ===================== */
let chartStatus = null, chartCourse = null;

// Auto reset by URL
(function autoResetByURL() {
    const q = new URLSearchParams(location.search);
    if (q.get('reset') === '1' || location.hash === '#reset-idb' || location.hash === '#hard-reset') {
        console.log('üîó URL reset triggered');
        setSkipSeedOnce();
        hardReset({silent: true, reload: true});
    }
})();

// Initialize app
(async function init() {
    console.log('üöÄ Initializing app...');
    try {
        const rows = await idbGetAll();
        console.log('üìä Loaded rows:', rows.length);
        
        if (rows.length === 0 && shouldSeed()) {
            console.log('üå± Seeding with sample data...');
            await importCSV(SAMPLE_CSV);
        }
        
        consumeSkipSeedOnce();
        bindHeader();
        setupColumnHiding();
        bindDelegation();
        await render();
        refreshTotals();
        console.log('‚úÖ App initialized successfully');
    } catch (error) {
        console.error('‚ùå Error initializing app:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
    }
})();

function bindHeader() {
    // Fullscreen
    byId('btnFullscreen').addEventListener('click', async () => {
        try {
            if (!document.fullscreenElement) {
                await document.documentElement.requestFullscreen();
            } else {
                await document.exitFullscreen();
            }
        } catch(e) {
            console.warn('Fullscreen error:', e);
        }
    });

    // No scroll mode
    byId('btnNoScroll').addEventListener('click', () => {
        const on = !document.body.classList.contains('present');
        document.body.classList.toggle('present', on);
        if (on) fitToViewport();
    });

    window.addEventListener('resize', () => {
        if (document.body.classList.contains('present')) {
            fitToViewport();
        }
    });

    // Add new row - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å render() ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    byId('btnAdd').addEventListener('click', async () => {
        try {
            const newItem = {
                id: uid(),
                subject: '‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà',
                batch: '1/xx',
                openDate: '-',
                learnDate: '-',
                cap: 15,
                reg: 0,
                left: 15,
                reserve: 0
            };
            console.log('‚ûï Adding new row...');
            await idbPut(newItem);
            await render(); // ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            refreshTotalsWithCurrentFilter();
            console.log('‚úÖ New row added successfully');
        } catch (error) {
            console.error('‚ùå Error adding row:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
    });

    // Clear data
    byId('btnClear').addEventListener('click', async () => {
        if (confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
            try {
                console.log('üîÑ Resetting to sample data...');
                await idbClear();
                await importCSV(SAMPLE_CSV);
                await render();
                refreshTotalsWithCurrentFilter();
                console.log('‚úÖ Reset completed');
            } catch (error) {
                console.error('‚ùå Error clearing data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }
    });

    // Export CSV
    byId('btnExport').addEventListener('click', async () => {
        try {
            const rows = await idbGetAll();
            const header = ['subject', 'batch', 'openDate', 'learnDate', 'cap', 'reg', 'left', 'reserve'];
            const lines = [header.join(',')];
            
            rows.forEach(r => {
                lines.push([
                    q(r.subject),
                    q(r.batch),
                    q(r.openDate),
                    q(r.learnDate),
                    r.cap,
                    r.reg,
                    r.left,
                    r.reserve || 0
                ].join(','));
            });
            
            const blob = new Blob([lines.join('\n')], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'weekday_courses.csv';
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                URL.revokeObjectURL(url);
                a.remove();
            }, 0);
            
            function q(s) {
                return `"${String(s || '').replaceAll('"', '""')}"`;
            }
            
            console.log('üì§ CSV exported:', rows.length, 'rows');
        } catch (error) {
            console.error('‚ùå Error exporting CSV:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        }
    });

    // ==== Import CSV ====
    byId('btnImport').addEventListener('click', () => {
        byId('csvArea').value = '';
        byId('csvFile').value = '';
        qs('#csvPreview').classList.add('hidden');
        qs('#mapFields').classList.add('hidden');
        byId('btnCommitCSV').disabled = true;
        byId('hasHeader').checked = true;
        byId('dlgImport').showModal();
    });

    byId('btnCloseImport').addEventListener('click', () => byId('dlgImport').close());

    byId('btnDownloadTemplate').addEventListener('click', () => {
        const header = 'subject,batch,openDate,learnDate,cap,reg,reserve\n';
        const blob = new Blob([header + SAMPLE_CSV], {type: 'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'template_weekday_courses.csv';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            URL.revokeObjectURL(url);
            a.remove();
        }, 0);
    });

    byId('csvFile').addEventListener('change', async e => {
        const file = e.target.files?.[0];
        if (!file) return;
        try {
            const text = await file.text();
            byId('csvArea').value = text.trim();
        } catch (error) {
            console.error('‚ùå Error reading file:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
        }
    });

    const dropArea = byId('dropArea');
    ['dragenter', 'dragover'].forEach(ev => {
        dropArea.addEventListener(ev, e => {
            e.preventDefault();
            dropArea.classList.add('drag');
        });
    });
    
    ['dragleave', 'drop'].forEach(ev => {
        dropArea.addEventListener(ev, e => {
            e.preventDefault();
            dropArea.classList.remove('drag');
        });
    });
    
    dropArea.addEventListener('drop', async e => {
        const file = e.dataTransfer?.files?.[0];
        if (!file) return;
        try {
            const text = await file.text();
            byId('csvArea').value = text.trim();
        } catch (error) {
            console.error('‚ùå Error reading dropped file:', error);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå');
        }
    });

    byId('btnParseCSV').addEventListener('click', () => parseAndPreview());
    byId('btnCommitCSV').addEventListener('click', commitImport);

    // Hard reset
    byId('btnHardReset')?.addEventListener('click', async () => {
        if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô IndexedDB ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ?\n(‡∏£‡∏ß‡∏°‡∏Ñ‡∏µ‡∏¢‡πå LocalStorage ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)')) {
            setSkipSeedOnce();
            await hardReset({silent: false, reload: true});
        }
    });

    // Auto Adjust Button
    byId('btnAutoAdjust').addEventListener('click', autoAdjustTable);
}

/* ====== Hide Columns Feature ====== */
function setupColumnHiding() {
    const hideColumnsBtn = byId('btnHideColumns');
    const hideColumnsMenu = byId('hideColumnsMenu');
    const columnToggles = document.querySelectorAll('.column-toggle');
    const hideAllBtn = byId('btnHideAllColumns');
    const showAllBtn = byId('btnShowAllColumns');
    
    hideColumnsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        hideColumnsMenu.classList.toggle('hidden');
    });
    
    document.addEventListener('click', () => {
        hideColumnsMenu.classList.add('hidden');
    });
    
    hideColumnsMenu.addEventListener('click', (e) => {
        e.stopPropagation();
    });
    
    columnToggles.forEach(toggle => {
        toggle.addEventListener('change', (e) => {
            const columnIndex = parseInt(e.target.dataset.column);
            const isHidden = !e.target.checked;
            toggleColumn(columnIndex, isHidden);
            saveColumnVisibility();
        });
    });
    
    hideAllBtn.addEventListener('click', () => {
        columnToggles.forEach(toggle => {
            toggle.checked = false;
            const columnIndex = parseInt(toggle.dataset.column);
            toggleColumn(columnIndex, true);
        });
        saveColumnVisibility();
    });
    
    showAllBtn.addEventListener('click', () => {
        columnToggles.forEach(toggle => {
            toggle.checked = true;
            const columnIndex = parseInt(toggle.dataset.column);
            toggleColumn(columnIndex, false);
        });
        saveColumnVisibility();
    });
    
    loadColumnVisibility();
}

function toggleColumn(columnIndex, hide) {
    const table = document.querySelector('table');
    if (!table) return;
    
    const headerCells = table.querySelectorAll('thead th');
    if (headerCells[columnIndex]) {
        headerCells[columnIndex].classList.toggle('hidden-column', hide);
    }
    
    const bodyRows = table.querySelectorAll('tbody tr');
    bodyRows.forEach(row => {
        const cell = row.cells[columnIndex];
        if (cell) {
            cell.classList.toggle('hidden-column', hide);
        }
    });
}

function saveColumnVisibility() {
    const visibility = {};
    document.querySelectorAll('.column-toggle').forEach(toggle => {
        const columnIndex = parseInt(toggle.dataset.column);
        visibility[columnIndex] = toggle.checked;
    });
    
    try {
        localStorage.setItem('columnVisibility', JSON.stringify(visibility));
    } catch (e) {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏î‡πâ:', e);
    }
}

function loadColumnVisibility() {
    try {
        const saved = localStorage.getItem('columnVisibility');
        if (saved) {
            const visibility = JSON.parse(saved);
            document.querySelectorAll('.column-toggle').forEach(toggle => {
                const columnIndex = parseInt(toggle.dataset.column);
                if (visibility.hasOwnProperty(columnIndex)) {
                    toggle.checked = visibility[columnIndex];
                    toggleColumn(columnIndex, !visibility[columnIndex]);
                }
            });
        }
    } catch (e) {
        console.warn('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÑ‡∏î‡πâ:', e);
    }
}

function fitToViewport() {
    const table = document.querySelector('table');
    const tb = table?.tBodies?.[0];
    if (!table || !tb || !tb.rows.length) return;
    
    const headerH = document.querySelector('header')?.offsetHeight || 0;
    const totalsH = byId('totalsBarContainer')?.offsetHeight || 0;
    const footerH = byId('updatedAt')?.parentElement?.offsetHeight || 0;
    const availH = window.innerHeight - headerH - totalsH - footerH - 24;
    const theadH = table.tHead?.offsetHeight || 0;
    
    let chosenFS = 14, chosenPad = 8;
    for (let fs = 16; fs >= 10; fs--) {
        const pad = Math.max(2, Math.floor((fs / 16) * 8));
        document.documentElement.style.setProperty('--fs-present', fs + 'px');
        document.documentElement.style.setProperty('--padY-present', pad + 'px');
        const rowH = tb.rows[0].getBoundingClientRect().height || 24;
        const need = theadH + rowH * tb.rows.length;
        if (need <= availH) {
            chosenFS = fs;
            chosenPad = pad;
            break;
        }
        if (fs === 10) {
            chosenFS = fs;
            chosenPad = pad;
        }
    }
    document.documentElement.style.setProperty('--fs-present', chosenFS + 'px');
    document.documentElement.style.setProperty('--padY-present', chosenPad + 'px');
}

/* ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏•‡∏ö */
function bindDelegation() {
    const tbody = byId('tbody');
    tbody.addEventListener('click', async (e) => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        
        const id = btn.dataset.id;
        const act = btn.dataset.act;
        
        if (act === 'edit') {
            const rows = await idbGetAll();
            const r = rows.find(x => x.id === id);
            if (!r) return;
            btn.closest('tr').innerHTML = editRowHtml(r);
            return;
        }
        
        if (act === 'cancel') {
            const rows = await idbGetAll();
            const r = rows.find(x => x.id === id);
            if (!r) return;
            const index = rows.findIndex(x => x.id === id);
            btn.closest('tr').innerHTML = viewRowHtml(r, index);
            return;
        }
        
        if (act === 'save') {
            btn.disabled = true;
            try {
                const tr = btn.closest('tr');
                const get = k => tr.querySelector(`[data-k="${k}"]`)?.value ?? '';
                
                const cap = clampNum(get('cap'), 0);
                const reg = clampNum(get('reg'), 0);
                const reserve = clampNum(get('reserve'), 0);
                
                const rows = await idbGetAll();
                const old = rows.find(x => x.id === id);
                if (!old) {
                    btn.disabled = false;
                    return;
                }
                
                const updated = {
                    ...old,
                    subject: String(get('subject')).trim() || old.subject,
                    batch: String(get('batch')).trim() || old.batch,
                    openDate: String(get('openDate')).trim() || old.openDate,
                    learnDate: String(get('learnDate')).trim() || old.learnDate,
                    cap: cap,
                    reg: reg,
                    reserve: reserve,
                    left: Math.max(0, cap - reg)
                };
                
                console.log('üíæ Saving data:', updated.subject);
                await idbPut(updated);
                await render();
                refreshTotalsWithCurrentFilter();
                console.log('‚úÖ Data saved successfully');
            } catch (error) {
                console.error('‚ùå Error saving data:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                btn.disabled = false;
            }
            return;
        }
        
        if (act === 'del') {
            if (confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    console.log('üóëÔ∏è Deleting row:', id);
                    await idbDelete(id);
                    await render();
                    refreshTotalsWithCurrentFilter();
                    console.log('‚úÖ Row deleted successfully');
                } catch (error) {
                    console.error('‚ùå Error deleting data:', error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }
            }
            return;
        }
    });
}

function statusBadgeHtml(r) {
    const pct = r.cap > 0 ? Math.round((r.reg / r.cap) * 100) : 0;
    if (pct >= 100) return `<span class="badge badge-red">100% ‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>`;
    if (pct >= 80) return `<span class="badge badge-amber">${pct}% ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°</span>`;
    return `<span class="badge badge-green">${pct}% ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ</span>`;
}

function viewRowHtml(r, i) {
    return `
        <td>${i + 1}</td>
        <td>${escapeHtml(r.subject)}</td>
        <td>${escapeHtml(r.batch)}</td>
        <td>${escapeHtml(r.openDate)}</td>
        <td>${escapeHtml(r.learnDate)}</td>
        <td>${r.cap}</td>
        <td>${r.reg}</td>
        <td>${r.left}</td>
        <td>${statusBadgeHtml(r)}</td>
        <td>${r.reserve || 0}</td>
        <td>
            <button type="button" class="btn btn-primary text-xs" data-act="edit" data-id="${r.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button type="button" class="btn btn-danger text-xs" data-act="del" data-id="${r.id}">‡∏•‡∏ö</button>
        </td>`;
}

function editRowHtml(r) {
    return `
        <td>-</td>
        <td><input value="${escapeHtml(r.subject)}" class="in w-[260px]" data-k="subject"></td>
        <td><input value="${escapeHtml(r.batch)}" class="in w-[80px]" data-k="batch"></td>
        <td><input value="${escapeHtml(r.openDate)}" class="in w-[120px]" data-k="openDate"></td>
        <td><input value="${escapeHtml(r.learnDate)}" class="in w-[160px]" data-k="learnDate"></td>
        <td><input type="number" min="0" value="${r.cap}" class="in" data-k="cap"></td>
        <td><input type="number" min="0" value="${r.reg}" class="in" data-k="reg"></td>
        <td class="text-slate-500">${Math.max(0, r.cap - r.reg)}</td>
        <td class="text-slate-500">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</td>
        <td><input type="number" min="0" value="${r.reserve || 0}" class="in" data-k="reserve"></td>
        <td>
            <button type="button" class="btn btn-primary text-xs" data-act="save" data-id="${r.id}">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button type="button" class="btn btn-ghost text-xs" data-act="cancel" data-id="${r.id}">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </td>`;
}

async function refreshBatchFilter(rows) {
    const sel = byId('batchFilter');
    if (!sel) return;

    const prev = sel.value;
    const batches = [...new Set(rows.map(r => r.batch).filter(b => b && b.trim() !== ""))];
    batches.sort();
    
    sel.innerHTML = '<option value="all">‡∏ó‡∏∏‡∏Å‡∏£‡∏∏‡πà‡∏ô</option>' + 
        batches.map(b => `<option value="${b}">${b}</option>`).join('');

    if (prev && [...sel.options].some(o => o.value === prev)) {
        sel.value = prev;
    } else {
        sel.value = "all";
    }

    sel.onchange = () => { render(); };
}

async function render() {
    try {
        const rows = await idbGetAll();
        const sel = byId('batchFilter');
        let filtered = rows;
        
        try {
            if (sel && sel.value && sel.value !== 'all') {
                filtered = rows.filter(r => (r.batch || '').toString() === sel.value);
            }
        } catch(e) {}

        const tbody = byId('tbody');
        tbody.innerHTML = '';
        const frag = document.createDocumentFragment();
        
        filtered.forEach((r, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = viewRowHtml(r, i);
            frag.appendChild(tr);
        });
        
        tbody.appendChild(frag);
        byId('rowsInfo').textContent = `‡πÅ‡∏™‡∏î‡∏á ${filtered.length} ‡∏à‡∏≤‡∏Å ${rows.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        byId('updatedAt').textContent = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + nowThai();
        
        await refreshCharts(filtered);
        await refreshBatchFilter(rows);
        await refreshTotals(filtered);
        
        console.log('üîÑ Table rendered:', filtered.length, 'rows');
    } catch (error) {
        console.error('‚ùå Error rendering table:', error);
    }
}

async function refreshCharts(rows) {
    const status = {full: 0, near: 0, ok: 0};
    const regBySubject = {};
    
    rows.forEach(r => {
        const pct = r.cap > 0 ? (r.reg / r.cap) * 100 : 0;
        if (pct >= 100) status.full++;
        else if (pct >= 80) status.near++;
        else status.ok++;
        
        regBySubject[r.subject] = (regBySubject[r.subject] || 0) + (+r.reg || 0);
    });
    
    try {
        if (chartStatus) chartStatus.destroy();
    } catch(e) {}
    
    try {
        if (chartCourse) chartCourse.destroy();
    } catch(e) {}
    
    // Status chart
    chartStatus = new Chart(byId('chartStatus'), {
        type: 'doughnut',
        data: {
            labels: ['‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß', '‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏°', '‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ'],
            datasets: [{
                data: [status.full, status.near, status.ok],
                backgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                hoverBackgroundColor: ['#ef4444', '#f59e0b', '#22c55e'],
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {color: '#d1fae5'}
                }
            },
            maintainAspectRatio: false
        }
    });
    
    // Course chart
    const labels = Object.keys(regBySubject);
    const values = labels.map(k => regBySubject[k]);
    
    chartCourse = new Chart(byId('chartCourse'), {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß',
                data: values,
                borderWidth: 0
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#d1fae5'
                    },
                    grid: {
                        color: 'rgba(148,163,184,.18)'
                    }
                },
                y: {
                    ticks: {
                        color: '#d1fae5',
                        precision: 0
                    },
                    grid: {
                        color: 'rgba(148,163,184,.18)'
                    }
                }
            },
            maintainAspectRatio: false
        }
    });
}

/* ====== CSV Import core ====== */
function detectDelimiter(sample) {
    const first = (sample.split(/\r?\n/).find(l => l.trim().length) || '');
    const counts = {
        ',': (first.match(/,/g) || []).length,
        ';': (first.match(/;/g) || []).length,
        '\t': (first.match(/\t/g) || []).length
    };
    let best = ',', max = -1;
    for (const [k, v] of Object.entries(counts)) {
        if (v > max) {
            max = v;
            best = k;
        }
    }
    return best;
}

function parseCSV(text) {
    if (!text) return {rows: [], delim: ','};
    const delim = detectDelimiter(text);
    const lines = text.split(/\r?\n/);
    const rows = [];
    for (const s of lines) {
        if (!s.trim()) continue;
        const out = [];
        let cur = '', quote = false;
        for (let i = 0; i < s.length; i++) {
            const ch = s[i];
            if (ch === '"') {
                if (quote && s[i + 1] === '"') {
                    cur += '"';
                    i++;
                } else {
                    quote = !quote;
                }
            } else if (ch === delim && !quote) {
                out.push(cur);
                cur = '';
            } else {
                cur += ch;
            }
        }
        out.push(cur);
        rows.push(out);
    }
    return {rows, delim};
}

const FIELD_LABELS = {
    subject: ['subject', '‡∏ß‡∏¥‡∏ä‡∏≤', '‡∏ß‡∏¥‡∏ä‡∏≤/‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£'],
    batch: ['batch', '‡∏£‡∏∏‡πà‡∏ô'],
    openDate: ['openDate', '‡∏ß‡∏±‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£', '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£'],
    learnDate: ['learnDate', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'],
    cap: ['cap', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö', '‡∏£‡∏±‡∏ö'],
    reg: ['reg', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', '‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£'],
    reserve: ['reserve', '‡∏™‡∏≥‡∏£‡∏≠‡∏á']
};

function autoMapHeaders(headers) {
    const map = {};
    const used = new Set();
    const norm = s => String(s || '').trim().toLowerCase();
    
    for (const [key, alts] of Object.entries(FIELD_LABELS)) {
        let idx = headers.findIndex(h => alts.map(a => a.toLowerCase()).includes(norm(h)));
        if (idx < 0) {
            for (let i = 0; i < headers.length; i++) {
                const h = norm(headers[i]);
                if (used.has(i)) continue;
                if (alts.some(a => h.includes(a.toLowerCase()))) {
                    idx = i;
                    break;
                }
            }
        }
        if (idx >= 0) {
            map[key] = idx;
            used.add(idx);
        }
    }
    return map;
}

function buildMappingUI(headers, hasHeader) {
    const target = byId('mapFields');
    target.innerHTML = '';
    const wrap = document.createElement('div');
    wrap.className = 'grid grid-cols-1 md:grid-cols-3 gap-2';
    
    const fields = ['subject', 'batch', 'openDate', 'learnDate', 'cap', 'reg', 'reserve'];
    const auto = hasHeader ? autoMapHeaders(headers) : {};
    
    fields.forEach(f => {
        const box = document.createElement('div');
        box.className = 'text-sm';
        const label = document.createElement('div');
        label.className = 'mb-1 font-bold';
        label.textContent = `‡πÅ‡∏°‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${f}`;
        const sel = document.createElement('select');
        sel.className = 'w-full bg-[#072f2a] border border-[#134e4a] rounded p-2';
        sel.dataset.f = f;
        
        const opts = headers.map((h, i) => ({
            v: i,
            t: hasHeader ? `${i + 1} ‚Äî ${h}` : `${i + 1}`
        }));
        
        sel.innerHTML = '<option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå--</option>' + 
            opts.map(o => `<option value="${o.v}">${escapeHtml(o.t)}</option>`).join('');
        
        if (auto[f] != null) {
            sel.value = String(auto[f]);
        }
        
        box.appendChild(label);
        box.appendChild(sel);
        wrap.appendChild(box);
    });
    
    target.appendChild(wrap);
    target.classList.remove('hidden');
}

function readMapping() {
    const sels = [...document.querySelectorAll('#mapFields select[data-f]')];
    const map = {};
    for (const s of sels) {
        const v = s.value;
        if (v === '') return null;
        map[s.dataset.f] = +v;
    }
    return map;
}

function renderPreview(rows, hasHeader) {
    const pv = byId('csvPreview');
    pv.innerHTML = '';
    pv.classList.remove('hidden');
    
    const table = document.createElement('table');
    table.className = 'w-full text-sm';
    
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    const cols = Math.max(...rows.map(r => r.length));
    
    for (let c = 0; c < cols; c++) {
        const th = document.createElement('th');
        th.className = 'px-2 py-1 bg-[#0a3a2f]';
        th.textContent = hasHeader ? (rows[0]?.[c] ?? `C${c + 1}`) : `C${c + 1}`;
        trh.appendChild(th);
    }
    
    thead.appendChild(trh);
    table.appendChild(thead);
    
    const tbody = document.createElement('tbody');
    const dataRows = hasHeader ? rows.slice(1) : rows.slice(0);
    
    dataRows.slice(0, 20).forEach(r => {
        const tr = document.createElement('tr');
        r = [...r];
        for (let c = 0; c < cols; c++) {
            const td = document.createElement('td');
            td.className = 'border-top border-[#134e4a] px-2 py-1';
            td.textContent = r[c] ?? '';
            tr.appendChild(td);
        }
        tbody.appendChild(tr);
    });
    
    table.appendChild(tbody);
    pv.appendChild(table);
    byId('btnCommitCSV').disabled = false;
}

function parseAndPreview() {
    const text = byId('csvArea').value.trim();
    if (!text) {
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡∏≥ CSV ‡∏°‡∏≤‡∏ß‡∏≤‡∏á');
        return;
    }
    
    const parsed = parseCSV(text);
    const rows = parsed.rows;
    
    if (rows.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô CSV');
        return;
    }
    
    const hasHeader = byId('hasHeader').checked;
    const headers = hasHeader ? rows[0] : Array.from({length: Math.max(...rows.map(r => r.length))}, (_, i) => `C${i + 1}`);
    
    buildMappingUI(headers, hasHeader);
    renderPreview(rows, hasHeader);
}

async function commitImport() {
    const text = byId('csvArea').value.trim();
    const parsed = parseCSV(text);
    
    if (parsed.rows.length === 0) {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô CSV');
        return;
    }
    
    const map = readMapping();
    if (!map) {
        alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏°‡∏õ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
        return;
    }
    
    const hasHeader = byId('hasHeader').checked;
    const dataRows = hasHeader ? parsed.rows.slice(1) : parsed.rows.slice(0);
    const items = [];
    
    for (const row of dataRows) {
        const get = k => row[map[k]] ?? '';
        const subject = String(get('subject')).trim();
        if (!subject) continue;
        
        const batch = String(get('batch')).trim();
        const cap = clampNum(get('cap'), 0);
        const reg = clampNum(get('reg'), 0);
        const reserve = clampNum(get('reserve'), 0);
        
        items.push({
            id: uid(),
            subject: subject,
            batch: batch,
            openDate: String(get('openDate') ?? '').trim(),
            learnDate: String(get('learnDate') ?? '').trim(),
            cap: cap,
            reg: reg,
            reserve: reserve,
            left: Math.max(0, cap - reg)
        });
    }
    
    try {
        if (byId('modeReplace').checked) {
            await idbClear();
            await idbBulkPut(items);
        } else {
            const existing = await idbGetAll();
            const idx = new Map(existing.map(r => [(r.subject || '') + '|' + (r.batch || ''), r]));
            
            for (const it of items) {
                const key = (it.subject || '') + '|' + (it.batch || '');
                const old = idx.get(key);
                if (old) {
                    await idbPut({...old, ...it, id: old.id});
                } else {
                    await idbPut(it);
                }
            }
        }
        
        byId('dlgImport').close();
        await render();
        refreshTotalsWithCurrentFilter();
        alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    } catch (error) {
        console.error('‚ùå Error importing CSV:', error);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
    }
}

/* ====== Import (default) for SAMPLE_CSV when needed ====== */
async function importCSV(text) {
    const parsed = parseCSV(text);
    const rows = parsed.rows;
    if (rows.length === 0) return;
    
    const map = {subject: 0, batch: 1, openDate: 2, learnDate: 3, cap: 4, reg: 5, reserve: 6};
    const dataRows = rows;
    const items = [];
    
    for (const row of dataRows) {
        const cap = clampNum(row[map.cap], 0);
        const reg = clampNum(row[map.reg], 0);
        const reserve = clampNum(row[map.reserve], 0);
        
        items.push({
            id: uid(),
            subject: String(row[map.subject] || '').trim(),
            batch: String(row[map.batch] || '').trim(),
            openDate: String(row[map.openDate] || '').trim(),
            learnDate: String(row[map.learnDate] || '').trim(),
            cap: cap,
            reg: reg,
            reserve: reserve,
            left: Math.max(0, cap - reg)
        });
    }
    
    await idbClear();
    await idbBulkPut(items);
}

/* ====== Totals ====== */
async function refreshTotals(rows = null) {
    try {
        if (!rows) {
            rows = await idbGetAll();
        }
        
        let totalReg = 0, full = 0, near = 0, ok = 0;
        for (const r of rows) {
            const cap = +r.cap || 0;
            const reg = +r.reg || 0;
            totalReg += reg;
            const pct = cap > 0 ? (reg / cap) * 100 : 0;
            if (pct >= 100) full++;
            else if (pct >= 80) near++;
            else ok++;
        }
        
        byId('totalApplicantsNum').textContent = totalReg.toLocaleString();
        byId('chipFull').textContent = `‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏•‡πâ‡∏ß ${full}`;
        byId('chipNear').textContent = `‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ï‡πá‡∏° ${near}`;
        byId('chipOk').textContent = `‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ ${ok}`;
    } catch(e) {
        console.error('‚ùå Error refreshing totals:', e);
    }
}

async function refreshTotalsWithCurrentFilter() {
    const sel = byId('batchFilter');
    if (sel && sel.value && sel.value !== 'all') {
        const rows = await idbGetAll();
        const filtered = rows.filter(r => (r.batch || '').toString() === sel.value);
        refreshTotals(filtered);
    } else {
        refreshTotals();
    }
}

// Event listeners for automatic totals refresh
const _tbodyObserverTarget = byId('tbody');
if (_tbodyObserverTarget) {
    new MutationObserver(() => {
        refreshTotalsWithCurrentFilter();
    }).observe(_tbodyObserverTarget, {childList: true});
}

document.body.addEventListener('click', e => {
    if (e.target.closest('button[data-act]')) {
        setTimeout(() => {
            refreshTotalsWithCurrentFilter();
        }, 100);
    }
});

// ==== Auto Adjust Function ====
function autoAdjustTable() {
    const table = byId('mainTable');
    if (!table) return;
    
    const headers = table.querySelectorAll('thead th');
    const rows = table.querySelectorAll('tbody tr');
    const maxWidths = Array.from(headers).map(() => 0);
    
    headers.forEach((header, index) => {
        const width = header.scrollWidth;
        maxWidths[index] = Math.max(maxWidths[index], width);
    });
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        cells.forEach((cell, index) => {
            const width = cell.scrollWidth;
            maxWidths[index] = Math.max(maxWidths[index], width);
        });
    });
    
    headers.forEach((header, index) => {
        header.style.minWidth = `${maxWidths[index] + 20}px`;
    });
    
    const containerWidth = table.parentElement.offsetWidth;
    const tableWidth = table.scrollWidth;
    
    if (tableWidth > containerWidth) {
        const scaleFactor = containerWidth / tableWidth;
        const currentFontSize = parseFloat(getComputedStyle(table).fontSize);
        const newFontSize = Math.max(10, currentFontSize * scaleFactor * 0.9);
        table.style.fontSize = `${newFontSize}px`;
    }
    
    const cells = table.querySelectorAll('th, td');
    cells.forEach(cell => {
        cell.style.padding = '6px 8px';
    });
    
    alert('‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
}

// ===== JSON Backup / Restore =====
(async function setupJSONBackup() {
    function download(filename, text, type = 'application/json') {
        const blob = new Blob([text], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
            URL.revokeObjectURL(url);
            a.remove();
        }, 0);
    }

    async function exportJSON() {
        try {
            const rows = await idbGetAll();
            const meta = {
                exportedAt: new Date().toISOString(),
                app: document.title || 'Courses',
                db: (typeof DB_NAME !== 'undefined' ? DB_NAME : 'UnknownDB')
            };
            const payload = {meta, rows};
            download((meta.db || 'data') + '_backup.json', JSON.stringify(payload, null, 2));
        } catch(err) {
            alert('Export JSON ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (err && err.message ? err.message : err));
        }
    }

    async function importJSONFile(file) {
        try {
            const text = await file.text();
            let payload;
            try {
                payload = JSON.parse(text);
            } catch(e) {
                alert('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà JSON ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            const rows = Array.isArray(payload) ? payload : (payload && payload.rows ? payload.rows : []);
            if (!Array.isArray(rows)) {
                alert('‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ rows');
                return;
            }
            
            if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON ‡πÅ‡∏•‡∏∞‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
            
            await idbClear();
            if (rows.length) {
                const normalized = rows.map((r, i) => {
                    const o = Object.assign({}, r);
                    if (!o.id) {
                        o.id = (r.id || (Date.now().toString(36) + '_' + i));
                    }
                    if (typeof o.cap !== 'undefined' && typeof o.reg !== 'undefined') {
                        const cap = parseInt(o.cap, 10) || 0;
                        const reg = parseInt(o.reg, 10) || 0;
                        o.left = Math.max(0, cap - reg);
                    }
                    return o;
                });
                await idbBulkPut(normalized);
            }
            
            if (typeof render === 'function') await render();
            if (typeof refreshTotals === 'function') {
                try {
                    refreshTotals();
                } catch(e) {}
            }
            alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + rows.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)');
        } catch(err) {
            alert('Import JSON ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + (err && err.message ? err.message : err));
        }
    }

    const btnBackup = document.getElementById('btnBackupJSON');
    const btnRestore = document.getElementById('btnRestoreJSON');
    const fileInput = document.getElementById('jsonFileInput');
    
    if (btnBackup) {
        btnBackup.addEventListener('click', exportJSON);
    }
    
    if (btnRestore && fileInput) {
        btnRestore.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            const f = e.target.files && e.target.files[0];
            if (f) importJSONFile(f);
            e.target.value = '';
        });
    }
})();
</script>

</body>
</html>